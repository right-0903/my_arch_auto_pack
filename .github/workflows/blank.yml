name: arch_package

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y arch-install-scripts zstd curl
    - name: pack the arch packages
      run: |
        curl http://mirror.rackspace.com/archlinux/iso/latest/archlinux-bootstrap-x86_64.tar.zst -o archlinux-bootstrap-x86_64.tar.zst
        tar xf ./archlinux-bootstrap-x86_64.tar.zst --numeric-owner
        echo 'Server = http://mirror.rackspace.com/archlinux/$repo/os/$arch' >> ./root.x86_64/etc/pacman.d/mirrorlist
        sed -i 's/#ParallelDownloads = 5/ParallelDownloads = 4/' ./root.x86_64/etc/pacman.conf
        cat ./root.x86_64/etc/pacman.d/mirrorlist | grep -Ei '^Server'
        cat ./root.x86_64/etc/pacman.conf | grep 'ParallelDownloads'
        # avoid pacman issue
        sudo chown root:root -R ./root.x86_64
        # refer to https://wiki.archlinux.org/title/Install_Arch_Linux_from_existing_Linux#Downloading_basic_tools
        sudo mount --bind ./root.x86_64/ ./root.x86_64/
        sudo arch-chroot ./root.x86_64/ sh -c 'pacman-key --init && pacman-key --populate && pacman -Syu --noconfirm'
        sudo arch-chroot ./root.x86_64/ pacman -S base-devel git wget --noconfirm
        # makepkg refuse to work when user is root, create a new user instead of hacking makepkg
        sudo arch-chroot ./root.x86_64/ sh -c 'useradd -m -s /bin/bash builduser && cd /home/builduser && su - builduser -c "git clone https://gitlab.archlinux.org/archlinux/packaging/packages/linux-lts.git"'
        sudo arch-chroot ./root.x86_64/ sh -c 'su - builduser -c "cd linux-lts/keys/pgp && gpg --import ./* "'
        # I don't docs
        sudo sed -i 's/"$pkgbase-docs"//g' ./root.x86_64/home/builduser/linux-lts/PKGBUILD
        # avoid the interactive shell for password
        sudo sh -c 'echo "builduser ALL=(ALL) NOPASSWD: /usr/bin/pacman" >> ./root.x86_64/etc/sudoers'
        # make use of cores
        sudo arch-chroot ./root.x86_64/ sh -c 'su - builduser -c "export MAKEFLAGS=-j$(nproc) && printenv MAKEFLAGS && cd linux-lts && wget https://ftp.nuvole.eu.org/0099-fix-pnp.patch && makepkg -s --noconfirm"'

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-lts
        path: |
          root.x86_64/home/builduser/linux-lts/linux-lts*.zst
